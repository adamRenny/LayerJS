/**
 * almond 0.2.3 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * @fileOverview
 * Copyright (c) 2012-2013 Adam Ranfelt
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without restriction,
 * including without limitation the rights to use, copy, modify, merge,
 * publish, distribute, sublicense, and/or sell copies of the Software,
 * and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
 * OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * LayerJS Definition
 * @author Adam Ranfelt
 * @author Aaron Gloege
 * @version 1.2
 */
(function(e,t){typeof exports=="object"?module.exports=t(global):typeof define=="function"&&define.amd?define([],function(){return t(null)}):t(e)})(this,function(e){var t,n,r;(function(e){function d(e,t){return h.call(e,t)}function v(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function m(t,n){return function(){return s.apply(e,p.call(arguments,0).concat([t,n]))}}function g(e){return function(t){return v(t,e)}}function y(e){return function(t){a[e]=t}}function b(t){if(d(f,t)){var n=f[t];delete f[t],c[t]=!0,i.apply(e,n)}if(!d(a,t)&&!d(c,t))throw new Error("No "+t);return a[t]}function w(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function E(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice;o=function(e,t){var n,r=w(e),i=r[0];return e=r[1],i&&(i=v(i,t),n=b(i)),i?n&&n.normalize?e=n.normalize(e,g(t)):e=v(e,t):(e=v(e,t),r=w(e),i=r[0],e=r[1],i&&(n=b(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return m(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:E(e)}}},i=function(t,n,r,i){var s,l,h,p,v,g=[],w;i=i||t;if(typeof r=="function"){n=!n.length&&r.length?["require","exports","module"]:n;for(v=0;v<n.length;v+=1){p=o(n[v],i),l=p.f;if(l==="require")g[v]=u.require(t);else if(l==="exports")g[v]=u.exports(t),w=!0;else if(l==="module")s=g[v]=u.module(t);else if(d(a,l)||d(f,l)||d(c,l))g[v]=b(l);else{if(!p.p)throw new Error(t+" missing "+l);p.p.load(p.n,m(i,!0),y(l),{}),g[v]=a[l]}}h=r.apply(a[t],g);if(t)if(s&&s.exports!==e&&s.exports!==a[t])a[t]=s.exports;else if(h!==e||!w)a[t]=h}else t&&(a[t]=r)},t=n=s=function(t,n,r,a,f){return typeof t=="string"?u[t]?u[t](n):b(o(t,n).f):(t.splice||(l=t,n.splice?(t=n,n=r,r=null):t=e),n=n||function(){},typeof r=="function"&&(r=a,a=f),a?i(e,t,n,r):setTimeout(function(){i(e,t,n,r)},15),s)},s.config=function(e){return l=e,s},r=function(e,t,n){t.splice||(n=t,t=[]),!d(a,e)&&!d(f,e)&&(f[e]=[e,t,n])},r.amd={jQuery:!0}})(),r("../tool/compiler/almond",function(){}),r("layer/Geometry",[],function(){var e={PI:Math.PI,TWO_PI:Math.PI*2,HALF_PI:Math.PI*.5,isPointInRect:function(e,t,n,r,i,s){return!(e<n||e>n+i||t<r||t>r+s)},isRectInRect:function(e,t,n,r,i,s,o,u){return i<=t&&s>=e&&o<=r&&u>=n},getDistanceBetweenPoints:function(e,t,n,r){return Math.sqrt(this.getSquaredDistanceBetweenPoints(e,t,n,r))},getSquaredDistanceBetweenPoints:function(e,t,n,r){var i=n-e,s=r-t;return i*i+s*s},isPointInCircle:function(e,t,n,r,i){return this.getSquaredDistanceBetweenPoints(e,t,n,r)<i*i},isPolarPointInPolarArea:function(e,t,n,r,i){return e<=n&&t>=r&&t<=i}};return e}),r("layer/HitEvent",[],function(){var e={mousemove:"onMouseMove",mouseup:"onMouseUp",mousedown:"onMouseDown",click:"onClick",mouseover:"onMouseOver",mouseout:"onMouseOut"},t=function(t,n,r,i,s){if(!e.hasOwnProperty(t))throw new Error("UndefinedError: HitEvent for "+t+" does not exist");if(n===undefined||typeof n!="number"||r===undefined||typeof r!="number")throw new Error("ArgumentsError: Error with x or y coordinates");this.type=t,this.callback=e[t],this.x=n,this.y=r,this.hitTarget=i,this.bubbles=s||!1,(i instanceof Array&&i.length||!(i instanceof Array)&&i!==null)&&this.executeHit()};return t.prototype.executeHit=function(){var e=this.callback,t=this.hitTarget;if(t instanceof Array){var n=t.length-1||0,r;do r=t[n],r[e]!==undefined&&r[e](this),n--;while(n>=0&&this.bubbles===!0)}else t[e]!==undefined&&t[e](this)},t.MOUSE_MOVE="mousemove",t.MOUSE_UP="mouseup",t.MOUSE_DOWN="mousedown",t.CLICK="click",t.MOUSE_OVER="mouseover",t.MOUSE_OUT="mouseout",t}),function(e,t){typeof exports=="object"?module.exports=t(global):typeof r=="function"&&r.amd?r("lib/requestAnimFrame",[],function(){return t(e)}):t(e)}(this,function(e,t){var n=1e3/60,r=function(){},i=null,s=null,o="requestAnimationFrame",u="cancelAnimationFrame",a=["","webkit","moz","o","ms"],f=null,l=function(e,t){var n=t+e.substr(0,1).toUpperCase()+e.substr(1);return n=n.substr(0,1).toLowerCase()+n.substr(1),n},i=function(){var r=0,s=a.length,u,c,h;for(;r<s;r++){u=a[r],c=l(o,u);if(e[c]!==t){h=e[i],f=a[r];break}}return h===t&&(h=function(t){return e.setTimeout(t,n)}),h}(),s=function(){var n;if(f===null)return e.clearTimeout;var i=l(u,f);return e[i]!==t?n=e[i]:n=r,n}();return e&&(e.requestAnimFrame=i,e.cancelAnimFrame=s),{requestAnimFrame:i,cancelAnimFrame:s}}),r("layer/RunLoop",["lib/requestAnimFrame"],function(e){var t=e.requestAnimFrame,n=e.cancelAnimFrame,r=400,i=-1,s=function(e,t,n){n===undefined||n>=e.length?e.push(t):n<0?e.unshift(t):e.splice(n,0,t)},o=function(e,t){var n=e.indexOf(t);if(n===i)throw new Error("UndefinedError: call has not been added");e.splice(n,1)},u=function(){this.init()};return u.prototype.init=function(){return this.lastTimestamp=Date.now(),this.isLooping=!1,this.step=this._step.bind(this),this.updateCallCycle=[],this.renderCallCycle=[],this},u.prototype.start=function(){return this.isLooping=!0,this.lastTimestamp=Date.now(),t(this.step),this},u.prototype.stop=function(){return this.isLooping=!1,n(this.step),this},u.prototype.addCall=function(e,t){if(t===undefined||t<=u.NO_CYCLE||t>u.ALL_CYCLES)throw new Error("ArgumentsError: type must be of type CYCLE enumeration");if(e===undefined||typeof e!="function")throw new Error("ArgumentsError: call must be of type function");return t&u.UPDATE_CYCLE&&s(this.updateCallCycle,e),t&u.RENDER_CYCLE&&s(this.renderCallCycle,e),this},u.prototype.insertCall=function(e,t,n){if(n===undefined||n<=u.NO_CYCLE||n>u.ALL_CYCLES)throw new Error("ArgumentsError: type must be of type CYCLE enumeration");if(e===undefined||typeof e!="function")throw new Error("ArgumentsError: call must be of type function");if(typeof t!="number")throw new Error("ArgumentsError: call must be of type number");return n&u.UPDATE_CYCLE&&s(this.updateCallCycle,e,t),n&u.RENDER_CYCLE&&s(this.renderCallCycle,e,t),this},u.prototype.removeCall=function(e,t){if(t===undefined||t<=u.NO_CYCLE||t>u.ALL_CYCLES)throw new Error("ArgumentsError: type must be of type CYCLE enumeration");if(e===undefined||typeof e!="function")throw new Error("ArgumentsError: call must be of type function");return t&u.UPDATE_CYCLE&&o(this.updateCallCycle,e),t&u.RENDER_CYCLE&&o(this.renderCallCycle,e),this},u.prototype.update=function(e){var t=0,n=this.updateCallCycle,r=n.length;for(;t<r;t++)n[t](e)},u.prototype.render=function(){var e=0,t=this.renderCallCycle,n=t.length;for(;e<n;e++)t[e]()},u.prototype._step=function(){if(!this.isLooping)return;t(this.step);var e=Date.now(),n=e-this.lastTimestamp;if(n>=r){this.lastTimestamp=e;return}this.update(n),this.render(),this.lastTimestamp=e},u.NO_CYCLE=0,u.UPDATE_CYCLE=1,u.RENDER_CYCLE=2,u.ALL_CYCLES=3,u}),r("lib/EventBus",[],function(){var e=window,t="function",n=".",r=-1,i=function(e){this.name=e,this.observers=[]};i.prototype.add=function(e){var t=this.observers;if(t.indexOf(e)!==r)return;t.push(e)},i.prototype.remove=function(e){var t=this.observers,n=t.indexOf(e);if(n===r)return;t.splice(n,1)},i.prototype.has=function(e){return this.observers.indexOf(e)!==r},i.prototype.trigger=function(t){var n=0,r=this.observers,i=r.length;t[0]=this.name;for(;n<i;n++)r[n].apply(e,t)};var s=function(e){this.name=e,this.event=new i(e),this.events={}};s.prototype.add=function(e,t){var n=this.events,r;t!==undefined?(n.hasOwnProperty(t)||(n[t]=new i(t)),r=n[t]):r=this.event,r.add(e)},s.prototype.remove=function(e,t){var n=this.events,r;t!==undefined?(n.hasOwnProperty(t)||(n[t]=new i(t)),r=n[t]):r=this.event,r.remove(e)},s.prototype.trigger=function(e,t){var n=this.events,r;n.hasOwnProperty(e)&&(r=n[e],r.trigger(t)),this.event.trigger(t)};var o=function(e){if(e===undefined)return this.events;var t=this.namespaces;return t.hasOwnProperty(e)||(t[e]=new s(e)),t[e]},u=function(){this.events=new s(""),this.namespaces={},this.getNamespace=o.bind(this)};return u.prototype.on=function(e,i){if(e===undefined||i===undefined)throw"UndefinedError: On usage: on(topic, callback)";if(typeof i!==t)throw"TypeError: Callback subscribing is of type "+typeof i+" not of type "+t;var s,o,u=e.lastIndexOf(n);e.charAt(0)===n&&e.length!==1?o=e.substr(1):u!==r&&u!==e.length-1?(o=e.substr(u+1),s=e.substr(0,u)):s=e;var a=this.getNamespace(o);return a.add(i,s),this},u.prototype.off=function(e,i){if(e===undefined||i===undefined)throw"UndefinedError: Off usage: on(topic, callback)";if(typeof i!==t)throw"TypeError: Callback subscribing is of type "+typeof i+" not of type "+t;var s,u,a=e.lastIndexOf(n);e.charAt(0)===n&&e.length!==1?u=e.substr(1):a!==r&&a!==e.length-1?(u=e.substr(a+1),s=e.substr(0,a)):s=e;var f=o.call(this,u);return f.remove(i,s),this},u.prototype.trigger=function(e){var t,i,s=e.lastIndexOf(n),o=this.namespaces;if(e.charAt(0)===n&&e.length!==1)throw"Error: triggering topic is a namespace and should be an event";return s!==r&&s!==e.length-1?(i=e.substr(s+1),t=e.substr(0,s)):t=e,i&&o.hasOwnProperty(i)&&o[i].trigger(t,arguments),this.events.trigger(t,arguments),this},u}),r("layer/EventBus",["lib/EventBus"],function(e){return new e}),r("layer/Input",["layer/EventBus","layer/Geometry"],function(e,t){var n=0,r=".input",i=document,s=window,o=i.body;Element.prototype.contains||(document.compareDocumentPosition?Element.prototype.contains=function(e){return e&&!!(this.compareDocumentPosition(e)&16)}:Element.prototype.contains=function(e){while(e=e.parentNode)if(e===this)return!0;return!1});var u=function(e,t){var n=e.getBoundingClientRect(),r=i.clientTop||o.clientTop||0,u=i.clientLeft||o.clientLeft||0,a=s.pageYOffset||i.scrollTop||0,f=s.pageXOffset||i.scrollLeft||0;t.top=n.top+a-r,t.left=n.left+f-u},a=function(){this.x=0,this.y=0},f=function(){var e=new a,t=function(t){e.x=t.pageX,e.y=t.pageY};return s.addEventListener("mousemove",t,!1),e}(),l=function(e){var t=e.target,n=e.relatedTarget;if(!n||n!==t&&!t.contains(n))e.type==="mouseover"?this.onEnter():this.onExit()},c=function(e){e!==undefined&&this.init(e)};return c.prototype.init=function(e){if(e===undefined||e===null)throw new Error("ArgumentsError: container not defined for Input");return this.namespace=r+n++,this.container=e,this.mouse=new a,this.enabled=!1,this.isActive=!1,this.isDragging=!1,this.isMouseOver=!1,this.containerOffset={top:0,left:0},this.setupHandlers().activate()},c.prototype.setupHandlers=function(){return this.onMoveHandler=this.onMove.bind(this),this.onDownHandler=this.onDown.bind(this),this.onUpHandler=this.onUp.bind(this),this.onTouchMoveHandler=this.onTouchMove.bind(this),this.onTouchStartHandler=this.onTouchStart.bind(this),this.onTouchEndHandler=this.onTouchEnd.bind(this),this.onClickHandler=this.onClick.bind(this),this.onEnterHandler=this.onEnter.bind(this),this.onExitHandler=this.onExit.bind(this),this.onResizeHandler=this.updateOffset.bind(this),this.onMouseEnterMouseLeaveHandler=l.bind(this),this},c.prototype.activate=function(){return this.isActive?this:(this.isActive=!0,this.container.addEventListener("mouseover",this.onMouseEnterMouseLeaveHandler,!1),this.container.addEventListener("mouseout",this.onMouseEnterMouseLeaveHandler,!1),this.container.addEventListener("touchstart",this.onEnterHandler,!1),this.container.addEventListener("touchstart",this.onTouchStartHandler,!1),s.addEventListener("resize",this.onResizeHandler,!1),this.updateOffset(),t.isPointInRect(f.x,f.y,this.containerOffset.left,this.containerOffset.top,this.container.clientWidth,this.container.clientHeight)&&this.onEnterHandler(),this)},c.prototype.deactivate=function(){return this.isActive?(this.isDragging&&this.stopDragging(),this.enabled&&this.disable(),this.isActive=!1,this.container.removeEventListener("mouseover",this.onMouseEnterMouseLeaveHandler,!1),this.container.removeEventListener("mouseout",this.onMouseEnterMouseLeaveHandler,!1),this.container.removeEventListener("touchstart",this.onEnterHandler,!1),this.container.removeEventListener("touchstart",this.onTouchStartHandler,!1),s.removeEventListener("resize",this.onResizeHandler,!1),this):this},c.prototype.enable=function(){return this.enabled?this:(this.enabled=!0,this.container.addEventListener("mousemove",this.onMoveHandler,!1),this.container.addEventListener("mousedown",this.onDownHandler,!1),this.container.addEventListener("click",this.onClickHandler,!1),this)},c.prototype.disable=function(){return!this.enabled||this.isDragging?this:(this.enabled=!1,this.container.removeEventListener("mousemove",this.onMoveHandler,!1),this.container.removeEventListener("mousedown",this.onDownHandler,!1),this.container.removeEventListener("click",this.onClickHandler,!1),e.trigger(c.DISABLE+this.namespace,this.mouse),this)},c.prototype.startDragging=function(){return this.isDragging?this:(c.CURRENTLY_DRAGGING=this.isDragging=!0,this.container.removeEventListener("mousemove",this.onMoveHandler,!1),s.addEventListener("mousemove",this.onMoveHandler,!1),s.addEventListener("mouseup",this.onUpHandler,!1),o.addEventListener("touchmove",this.onTouchMoveHandler,!1),o.addEventListener("touchend",this.onTouchEndHandler,!1),this)},c.prototype.stopDragging=function(){return this.isDragging?(c.CURRENTLY_DRAGGING=this.isDragging=!1,s.removeEventListener("mousemove",this.onMoveHandler,!1),s.removeEventListener("mouseup",this.onUpHandler,!1),o.removeEventListener("touchmove",this.onTouchMoveHandler,!1),o.removeEventListener("touchend",this.onTouchEndHandler,!1),this.isMouseOver?this.container.addEventListener("mousemove",this.onMoveHandler,!1):this.onExit(),this):this},c.prototype.getNamespace=function(){return this.namespace},c.prototype.onMove=function(t){this.mouse.x=t.pageX-this.containerOffset.left,this.mouse.y=t.pageY-this.containerOffset.top,e.trigger(c.MOUSE_MOVE+this.namespace,this.mouse)},c.prototype.onUp=function(t){this.mouse.x=t.pageX-this.containerOffset.left,this.mouse.y=t.pageY-this.containerOffset.top,e.trigger(c.MOUSE_UP+this.namespace,this.mouse),this.stopDragging()},c.prototype.onDown=function(t){if(t.which!==1)return;this.updateOffset(),this.mouse.x=t.pageX-this.containerOffset.left,this.mouse.y=t.pageY-this.containerOffset.top,e.trigger(c.MOUSE_DOWN+this.namespace,this.mouse),this.startDragging()},c.prototype.onTouchMove=function(t){this.mouse.x=t.touches[0].pageX-this.containerOffset.left,this.mouse.y=t.touches[0].pageY-this.containerOffset.top,t.preventDefault(),e.trigger(c.MOUSE_MOVE+this.namespace,this.mouse)},c.prototype.onTouchEnd=function(t){e.trigger(c.MOUSE_UP+this.namespace,this.mouse),this.stopDragging()},c.prototype.onTouchStart=function(t){this.updateOffset(),this.mouse.x=t.touches[0].pageX-this.containerOffset.left,this.mouse.y=t.touches[0].pageY-this.containerOffset.top,e.trigger(c.MOUSE_DOWN+this.namespace,this.mouse),this.startDragging()},c.prototype.onClick=function(t){this.mouse.x=t.pageX-this.containerOffset.left,this.mouse.y=t.pageY-this.containerOffset.top,e.trigger(c.CLICK+this.namespace,this.mouse)},c.prototype.onEnter=function(e){c.CURRENTLY_DRAGGING||(this.isMouseOver=!0,this.updateOffset().enable())},c.prototype.onExit=function(e){this.isMouseOver=!1,this.disable()},c.prototype.updateOffset=function(){return u(this.container,this.containerOffset),this},c.MOUSE_MOVE="input/mousemove",c.MOUSE_UP="input/mouseup",c.MOUSE_DOWN="input/mousedown",c.CLICK="input/mouseclick",c.DISABLE="input/disable",c.CURRENTLY_DRAGGING=!1,c}),r("layer/RenderRequest",[],function(){var e=function(){this.init()};return e.prototype.init=function(){return this.sceneRenderStack={},this},e.prototype.setNeedsRender=function(e){return this.sceneRenderStack[e]=!0,this},e.prototype.getNeedsRender=function(e){var t=this.sceneRenderStack[e];return this.sceneRenderStack[e]=!1,t},e}),r("layer/RenderMediator",["layer/RenderRequest"],function(e){return new e}),function(e,t){typeof exports=="object"?module.exports=t(global):typeof r=="function"&&r.amd?r("lib/gl-matrix",[],function(){return t(e)}):t(e)}(this,function(e){function i(e){return r=e,r}function s(){return r=typeof Float32Array!="undefined"?Float32Array:Array,r}var t=1e-6,n={};(function(){if(typeof Float32Array!="undefined"){var e=new Float32Array(1),t=new Int32Array(e.buffer);n.invsqrt=function(n){var r=n*.5;e[0]=n;var i=1.5;t[0]=1597463007-(t[0]>>1);var s=e[0];return s*(i-r*s*s)}}else n.invsqrt=function(e){return 1/Math.sqrt(e)}})();var r=null;s();var o={};o.create=function(e){var t=new r(3);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):t[0]=t[1]=t[2]=0,t},o.createFrom=function(e,t,n){var i=new r(3);return i[0]=e,i[1]=t,i[2]=n,i},o.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},o.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t},o.add=function(e,t,n){return!n||e===n?(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e):(n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n)},o.subtract=function(e,t,n){return!n||e===n?(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e):(n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n)},o.multiply=function(e,t,n){return!n||e===n?(e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],e):(n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n)},o.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},o.scale=function(e,t,n){return!n||e===n?(e[0]*=t,e[1]*=t,e[2]*=t,e):(n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n)},o.normalize=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=Math.sqrt(n*n+r*r+i*i);return s?s===1?(t[0]=n,t[1]=r,t[2]=i,t):(s=1/s,t[0]=n*s,t[1]=r*s,t[2]=i*s,t):(t[0]=0,t[1]=0,t[2]=0,t)},o.cross=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=t[0],u=t[1],a=t[2];return n[0]=i*a-s*u,n[1]=s*o-r*a,n[2]=r*u-i*o,n},o.length=function(e){var t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)},o.squaredLength=function(e){var t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r},o.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},o.direction=function(e,t,n){n||(n=e);var r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],o=Math.sqrt(r*r+i*i+s*s);return o?(o=1/o,n[0]=r*o,n[1]=i*o,n[2]=s*o,n):(n[0]=0,n[1]=0,n[2]=0,n)},o.lerp=function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r[2]=e[2]+n*(t[2]-e[2]),r},o.dist=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+r*r+i*i)};var u=null,a=new r(4);o.unproject=function(e,t,n,r,i){i||(i=e),u||(u=d.create());var s=u,o=a;return o[0]=(e[0]-r[0])*2/r[2]-1,o[1]=(e[1]-r[1])*2/r[3]-1,o[2]=2*e[2]-1,o[3]=1,d.multiply(n,t,s),d.inverse(s)?(d.multiplyVec4(s,o),o[3]===0?null:(i[0]=o[0]/o[3],i[1]=o[1]/o[3],i[2]=o[2]/o[3],i)):null};var f=o.createFrom(1,0,0),l=o.createFrom(0,1,0),c=o.createFrom(0,0,1),h=o.create();o.rotationTo=function(e,t,n){n||(n=v.create());var r=o.dot(e,t),i=h;if(r>=1)v.set(m,n);else if(r<1e-6-1)o.cross(f,e,i),o.length(i)<1e-6&&o.cross(l,e,i),o.length(i)<1e-6&&o.cross(c,e,i),o.normalize(i),v.fromAngleAxis(Math.PI,i,n);else{var s=Math.sqrt((1+r)*2),u=1/s;o.cross(e,t,i),n[0]=i[0]*u,n[1]=i[1]*u,n[2]=i[2]*u,n[3]=s*.5,v.normalize(n)}return n[3]>1?n[3]=1:n[3]<-1&&(n[3]=-1),n},o.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"};var p={};p.create=function(e){var t=new r(9);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8]):t[0]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=0,t},p.createFrom=function(e,t,n,i,s,o,u,a,f){var l=new r(9);return l[0]=e,l[1]=t,l[2]=n,l[3]=i,l[4]=s,l[5]=o,l[6]=u,l[7]=a,l[8]=f,l},p.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8];return t*(f*s-o*a)+n*(-f*i+o*u)+r*(a*i-s*u)},p.inverse=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=e[6],f=e[7],l=e[8],c=l*o-u*f,h=-l*s+u*a,d=f*s-o*a,v=n*c+r*h+i*d,m;return v?(m=1/v,t||(t=p.create()),t[0]=c*m,t[1]=(-l*r+i*f)*m,t[2]=(u*r-i*o)*m,t[3]=h*m,t[4]=(l*n-i*a)*m,t[5]=(-u*n+i*s)*m,t[6]=d*m,t[7]=(-f*n+r*a)*m,t[8]=(o*n-r*s)*m,t):null},p.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=t[0],p=t[1],d=t[2],v=t[3],m=t[4],g=t[5],y=t[6],b=t[7],w=t[8];return n[0]=h*r+p*o+d*f,n[1]=h*i+p*u+d*l,n[2]=h*s+p*a+d*c,n[3]=v*r+m*o+g*f,n[4]=v*i+m*u+g*l,n[5]=v*s+m*a+g*c,n[6]=y*r+b*o+w*f,n[7]=y*i+b*u+w*l,n[8]=y*s+b*a+w*c,n},p.multiplyVec2=function(e,t,n){n||(n=t);var r=t[0],i=t[1];return n[0]=r*e[0]+i*e[3]+e[6],n[1]=r*e[1]+i*e[4]+e[7],n},p.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2];return n[0]=r*e[0]+i*e[3]+s*e[6],n[1]=r*e[1]+i*e[4]+s*e[7],n[2]=r*e[2]+i*e[5]+s*e[8],n},p.translate=function(e,t,n){var r=t[0],i=t[1],s,o,u,a,f,l,c,h,p;return!n||e===n?(e[6]=e[0]*r+e[3]*i+e[6],e[7]=e[1]*r+e[4]*i+e[7],e[8]=e[2]*r+e[5]*i+e[8],e):(s=e[0],o=e[1],u=e[2],a=e[3],f=e[4],l=e[5],c=e[6],h=e[7],p=e[8],n[0]=s,n[1]=o,n[2]=u,n[3]=a,n[4]=f,n[5]=l,n[6]=c,n[7]=h,n[8]=p,n[6]=e[0]*r+e[3]*i+e[6],n[7]=e[1]*r+e[4]*i+e[7],n[8]=e[2]*r+e[5]*i+e[8],n)},p.scale=function(e,t,n){var r=t[0],i=t[1];return!n||e===n?(e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=i,e[4]*=i,e[5]*=i,e):(n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*i,n[4]=e[4]*i,n[5]=e[5]*i,n[6]=e[6],n[7]=e[7],n[8]=e[8],n)},p.rotate=function(e,t,n){var r=Math.sin(t),i=Math.cos(t),s=e[0],o=e[1],u=e[2],a=e[3],f=e[4],l=e[5];return n?e!==n&&(n[6]=e[6],n[7]=e[7],n[8]=e[8]):n=e,n[0]=s*i+a*r,n[1]=o*i+f*r,n[2]=u*i+l*r,n[3]=s*-r+a*i,n[4]=o*-r+f*i,n[5]=u*-r+l*i,n},p.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},p.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t&&Math.abs(e[4]-n[4])<t&&Math.abs(e[5]-n[5])<t&&Math.abs(e[6]-n[6])<t&&Math.abs(e[7]-n[7])<t&&Math.abs(e[8]-n[8])<t},p.identity=function(e){return e||(e=p.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},p.transpose=function(e,t){if(!t||e===t){var n=e[1],r=e[2],i=e[5];return e[1]=e[3],e[2]=e[6],e[3]=n,e[5]=e[7],e[6]=r,e[7]=i,e}return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t},p.toMat4=function(e,t){return t||(t=d.create()),t[15]=1,t[14]=0,t[13]=0,t[12]=0,t[11]=0,t[10]=e[8],t[9]=e[7],t[8]=e[6],t[7]=0,t[6]=e[5],t[5]=e[4],t[4]=e[3],t[3]=0,t[2]=e[2],t[1]=e[1],t[0]=e[0],t},p.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]"};var d={};d.create=function(e){var t=new r(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},d.createFrom=function(e,t,n,i,s,o,u,a,f,l,c,h,p,d,v,m){var g=new r(16);return g[0]=e,g[1]=t,g[2]=n,g[3]=i,g[4]=s,g[5]=o,g[6]=u,g[7]=a,g[8]=f,g[9]=l,g[10]=c,g[11]=h,g[12]=p,g[13]=d,g[14]=v,g[15]=m,g},d.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},d.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t&&Math.abs(e[4]-n[4])<t&&Math.abs(e[5]-n[5])<t&&Math.abs(e[6]-n[6])<t&&Math.abs(e[7]-n[7])<t&&Math.abs(e[8]-n[8])<t&&Math.abs(e[9]-n[9])<t&&Math.abs(e[10]-n[10])<t&&Math.abs(e[11]-n[11])<t&&Math.abs(e[12]-n[12])<t&&Math.abs(e[13]-n[13])<t&&Math.abs(e[14]-n[14])<t&&Math.abs(e[15]-n[15])<t},d.identity=function(e){return e||(e=d.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},d.transpose=function(e,t){if(!t||e===t){var n=e[1],r=e[2],i=e[3],s=e[6],o=e[7],u=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=n,e[6]=e[9],e[7]=e[13],e[8]=r,e[9]=s,e[11]=e[14],e[12]=i,e[13]=o,e[14]=u,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},d.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11],p=e[12],d=e[13],v=e[14],m=e[15];return p*l*u*i-f*d*u*i-p*o*c*i+s*d*c*i+f*o*v*i-s*l*v*i-p*l*r*a+f*d*r*a+p*n*c*a-t*d*c*a-f*n*v*a+t*l*v*a+p*o*r*h-s*d*r*h-p*n*u*h+t*d*u*h+s*n*v*h-t*o*v*h-f*o*r*m+s*l*r*m+f*n*u*m-t*l*u*m-s*n*c*m+t*o*c*m},d.inverse=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=e[6],f=e[7],l=e[8],c=e[9],h=e[10],p=e[11],d=e[12],v=e[13],m=e[14],g=e[15],y=n*u-r*o,b=n*a-i*o,w=n*f-s*o,E=r*a-i*u,S=r*f-s*u,x=i*f-s*a,T=l*v-c*d,N=l*m-h*d,C=l*g-p*d,k=c*m-h*v,L=c*g-p*v,A=h*g-p*m,O=y*A-b*L+w*k+E*C-S*N+x*T,M;return O?(M=1/O,t[0]=(u*A-a*L+f*k)*M,t[1]=(-r*A+i*L-s*k)*M,t[2]=(v*x-m*S+g*E)*M,t[3]=(-c*x+h*S-p*E)*M,t[4]=(-o*A+a*C-f*N)*M,t[5]=(n*A-i*C+s*N)*M,t[6]=(-d*x+m*w-g*b)*M,t[7]=(l*x-h*w+p*b)*M,t[8]=(o*L-u*C+f*T)*M,t[9]=(-n*L+r*C-s*T)*M,t[10]=(d*S-v*w+g*y)*M,t[11]=(-l*S+c*w-p*y)*M,t[12]=(-o*k+u*N-a*T)*M,t[13]=(n*k-r*N+i*T)*M,t[14]=(-d*E+v*b-m*y)*M,t[15]=(l*E-c*b+h*y)*M,t):null},d.toRotationMat=function(e,t){return t||(t=d.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},d.toMat3=function(e,t){return t||(t=p.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},d.toInverseMat3=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[4],o=e[5],u=e[6],a=e[8],f=e[9],l=e[10],c=l*o-u*f,h=-l*s+u*a,d=f*s-o*a,v=n*c+r*h+i*d,m;return v?(m=1/v,t||(t=p.create()),t[0]=c*m,t[1]=(-l*r+i*f)*m,t[2]=(u*r-i*o)*m,t[3]=h*m,t[4]=(l*n-i*a)*m,t[5]=(-u*n+i*s)*m,t[6]=d*m,t[7]=(-f*n+r*a)*m,t[8]=(o*n-r*s)*m,t):null},d.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=e[9],p=e[10],d=e[11],v=e[12],m=e[13],g=e[14],y=e[15],b=t[0],w=t[1],E=t[2],S=t[3];return n[0]=b*r+w*u+E*c+S*v,n[1]=b*i+w*a+E*h+S*m,n[2]=b*s+w*f+E*p+S*g,n[3]=b*o+w*l+E*d+S*y,b=t[4],w=t[5],E=t[6],S=t[7],n[4]=b*r+w*u+E*c+S*v,n[5]=b*i+w*a+E*h+S*m,n[6]=b*s+w*f+E*p+S*g,n[7]=b*o+w*l+E*d+S*y,b=t[8],w=t[9],E=t[10],S=t[11],n[8]=b*r+w*u+E*c+S*v,n[9]=b*i+w*a+E*h+S*m,n[10]=b*s+w*f+E*p+S*g,n[11]=b*o+w*l+E*d+S*y,b=t[12],w=t[13],E=t[14],S=t[15],n[12]=b*r+w*u+E*c+S*v,n[13]=b*i+w*a+E*h+S*m,n[14]=b*s+w*f+E*p+S*g,n[15]=b*o+w*l+E*d+S*y,n},d.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2];return n[0]=e[0]*r+e[4]*i+e[8]*s+e[12],n[1]=e[1]*r+e[5]*i+e[9]*s+e[13],n[2]=e[2]*r+e[6]*i+e[10]*s+e[14],n},d.multiplyVec4=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2],o=t[3];return n[0]=e[0]*r+e[4]*i+e[8]*s+e[12]*o,n[1]=e[1]*r+e[5]*i+e[9]*s+e[13]*o,n[2]=e[2]*r+e[6]*i+e[10]*s+e[14]*o,n[3]=e[3]*r+e[7]*i+e[11]*s+e[15]*o,n},d.translate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o,u,a,f,l,c,h,p,d,v,m,g;return!n||e===n?(e[12]=e[0]*r+e[4]*i+e[8]*s+e[12],e[13]=e[1]*r+e[5]*i+e[9]*s+e[13],e[14]=e[2]*r+e[6]*i+e[10]*s+e[14],e[15]=e[3]*r+e[7]*i+e[11]*s+e[15],e):(o=e[0],u=e[1],a=e[2],f=e[3],l=e[4],c=e[5],h=e[6],p=e[7],d=e[8],v=e[9],m=e[10],g=e[11],n[0]=o,n[1]=u,n[2]=a,n[3]=f,n[4]=l,n[5]=c,n[6]=h,n[7]=p,n[8]=d,n[9]=v,n[10]=m,n[11]=g,n[12]=o*r+l*i+d*s+e[12],n[13]=u*r+c*i+v*s+e[13],n[14]=a*r+h*i+m*s+e[14],n[15]=f*r+p*i+g*s+e[15],n)},d.scale=function(e,t,n){var r=t[0],i=t[1],s=t[2];return!n||e===n?(e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=r,e[4]*=i,e[5]*=i,e[6]*=i,e[7]*=i,e[8]*=s,e[9]*=s,e[10]*=s,e[11]*=s,e):(n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*i,n[5]=e[5]*i,n[6]=e[6]*i,n[7]=e[7]*i,n[8]=e[8]*s,n[9]=e[9]*s,n[10]=e[10]*s,n[11]=e[11]*s,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n)},d.rotate=function(e,t,n,r){var i=n[0],s=n[1],o=n[2],u=Math.sqrt(i*i+s*s+o*o),a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M;return u?(u!==1&&(u=1/u,i*=u,s*=u,o*=u),a=Math.sin(t),f=Math.cos(t),l=1-f,c=e[0],h=e[1],p=e[2],d=e[3],v=e[4],m=e[5],g=e[6],y=e[7],b=e[8],w=e[9],E=e[10],S=e[11],x=i*i*l+f,T=s*i*l+o*a,N=o*i*l-s*a,C=i*s*l-o*a,k=s*s*l+f,L=o*s*l+i*a,A=i*o*l+s*a,O=s*o*l-i*a,M=o*o*l+f,r?e!==r&&(r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=c*x+v*T+b*N,r[1]=h*x+m*T+w*N,r[2]=p*x+g*T+E*N,r[3]=d*x+y*T+S*N,r[4]=c*C+v*k+b*L,r[5]=h*C+m*k+w*L,r[6]=p*C+g*k+E*L,r[7]=d*C+y*k+S*L,r[8]=c*A+v*O+b*M,r[9]=h*A+m*O+w*M,r[10]=p*A+g*O+E*M,r[11]=d*A+y*O+S*M,r):null},d.rotateX=function(e,t,n){var r=Math.sin(t),i=Math.cos(t),s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11];return n?e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[4]=s*i+f*r,n[5]=o*i+l*r,n[6]=u*i+c*r,n[7]=a*i+h*r,n[8]=s*-r+f*i,n[9]=o*-r+l*i,n[10]=u*-r+c*i,n[11]=a*-r+h*i,n},d.rotateY=function(e,t,n){var r=Math.sin(t),i=Math.cos(t),s=e[0],o=e[1],u=e[2],a=e[3],f=e[8],l=e[9],c=e[10],h=e[11];return n?e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=s*i+f*-r,n[1]=o*i+l*-r,n[2]=u*i+c*-r,n[3]=a*i+h*-r,n[8]=s*r+f*i,n[9]=o*r+l*i,n[10]=u*r+c*i,n[11]=a*r+h*i,n},d.rotateZ=function(e,t,n){var r=Math.sin(t),i=Math.cos(t),s=e[0],o=e[1],u=e[2],a=e[3],f=e[4],l=e[5],c=e[6],h=e[7];return n?e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=s*i+f*r,n[1]=o*i+l*r,n[2]=u*i+c*r,n[3]=a*i+h*r,n[4]=s*-r+f*i,n[5]=o*-r+l*i,n[6]=u*-r+c*i,n[7]=a*-r+h*i,n},d.frustum=function(e,t,n,r,i,s,o){o||(o=d.create());var u=t-e,a=r-n,f=s-i;return o[0]=i*2/u,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=i*2/a,o[6]=0,o[7]=0,o[8]=(t+e)/u,o[9]=(r+n)/a,o[10]=-(s+i)/f,o[11]=-1,o[12]=0,o[13]=0,o[14]=-(s*i*2)/f,o[15]=0,o},d.perspective=function(e,t,n,r,i){var s=n*Math.tan(e*Math.PI/360),o=s*t;return d.frustum(-o,o,-s,s,n,r,i)},d.ortho=function(e,t,n,r,i,s,o){o||(o=d.create());var u=t-e,a=r-n,f=s-i;return o[0]=2/u,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/a,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-2/f,o[11]=0,o[12]=-(e+t)/u,o[13]=-(r+n)/a,o[14]=-(s+i)/f,o[15]=1,o},d.lookAt=function(e,t,n,r){r||(r=d.create());var i,s,o,u,a,f,l,c,h,p,v=e[0],m=e[1],g=e[2],y=n[0],b=n[1],w=n[2],E=t[0],S=t[1],x=t[2];return v===E&&m===S&&g===x?d.identity(r):(l=v-E,c=m-S,h=g-x,p=1/Math.sqrt(l*l+c*c+h*h),l*=p,c*=p,h*=p,i=b*h-w*c,s=w*l-y*h,o=y*c-b*l,p=Math.sqrt(i*i+s*s+o*o),p?(p=1/p,i*=p,s*=p,o*=p):(i=0,s=0,o=0),u=c*o-h*s,a=h*i-l*o,f=l*s-c*i,p=Math.sqrt(u*u+a*a+f*f),p?(p=1/p,u*=p,a*=p,f*=p):(u=0,a=0,f=0),r[0]=i,r[1]=u,r[2]=l,r[3]=0,r[4]=s,r[5]=a,r[6]=c,r[7]=0,r[8]=o,r[9]=f,r[10]=h,r[11]=0,r[12]=-(i*v+s*m+o*g),r[13]=-(u*v+a*m+f*g),r[14]=-(l*v+c*m+h*g),r[15]=1,r)},d.fromRotationTranslation=function(e,t,n){n||(n=d.create());var r=e[0],i=e[1],s=e[2],o=e[3],u=r+r,a=i+i,f=s+s,l=r*u,c=r*a,h=r*f,p=i*a,v=i*f,m=s*f,g=o*u,y=o*a,b=o*f;return n[0]=1-(p+m),n[1]=c+b,n[2]=h-y,n[3]=0,n[4]=c-b,n[5]=1-(l+m),n[6]=v+g,n[7]=0,n[8]=h+y,n[9]=v-g,n[10]=1-(l+p),n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n},d.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"};var v={};v.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):t[0]=t[1]=t[2]=t[3]=0,t},v.createFrom=function(e,t,n,i){var s=new r(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s},v.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},v.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t},v.identity=function(e){return e||(e=v.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e};var m=v.identity();v.calculateW=function(e,t){var n=e[0],r=e[1],i=e[2];return!t||e===t?(e[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i)),e):(t[0]=n,t[1]=r,t[2]=i,t[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i)),t)},v.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},v.inverse=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=n*n+r*r+i*i+s*s,u=o?1/o:0;return!t||e===t?(e[0]*=-u,e[1]*=-u,e[2]*=-u,e[3]*=u,e):(t[0]=-e[0]*u,t[1]=-e[1]*u,t[2]=-e[2]*u,t[3]=e[3]*u,t)},v.conjugate=function(e,t){return!t||e===t?(e[0]*=-1,e[1]*=-1,e[2]*=-1,e):(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t)},v.length=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)},v.normalize=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=Math.sqrt(n*n+r*r+i*i+s*s);return o===0?(t[0]=0,t[1]=0,t[2]=0,t[3]=0,t):(o=1/o,t[0]=n*o,t[1]=r*o,t[2]=i*o,t[3]=s*o,t)},v.add=function(e,t,n){return!n||e===n?(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],e):(n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n)},v.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=t[0],a=t[1],f=t[2],l=t[3];return n[0]=r*l+o*u+i*f-s*a,n[1]=i*l+o*a+s*u-r*f,n[2]=s*l+o*f+r*a-i*u,n[3]=o*l-r*u-i*a-s*f,n},v.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2],o=e[0],u=e[1],a=e[2],f=e[3],l=f*r+u*s-a*i,c=f*i+a*r-o*s,h=f*s+o*i-u*r,p=-o*r-u*i-a*s;return n[0]=l*f+p*-o+c*-a-h*-u,n[1]=c*f+p*-u+h*-o-l*-a,n[2]=h*f+p*-a+l*-u-c*-o,n},v.scale=function(e,t,n){return!n||e===n?(e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e):(n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n)},v.toMat3=function(e,t){t||(t=p.create());var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,d=r*a,v=i*a,m=s*o,g=s*u,y=s*a;return t[0]=1-(h+v),t[1]=l+y,t[2]=c-g,t[3]=l-y,t[4]=1-(f+v),t[5]=d+m,t[6]=c+g,t[7]=d-m,t[8]=1-(f+h),t},v.toMat4=function(e,t){t||(t=d.create());var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,p=r*a,v=i*a,m=s*o,g=s*u,y=s*a;return t[0]=1-(h+v),t[1]=l+y,t[2]=c-g,t[3]=0,t[4]=l-y,t[5]=1-(f+v),t[6]=p+m,t[7]=0,t[8]=c+g,t[9]=p-m,t[10]=1-(f+h),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},v.slerp=function(e,t,n,r){r||(r=e);var i=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3],s,o,u,a;return Math.abs(i)>=1?(r!==e&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3]),r):(s=Math.acos(i),o=Math.sqrt(1-i*i),Math.abs(o)<.001?(r[0]=e[0]*.5+t[0]*.5,r[1]=e[1]*.5+t[1]*.5,r[2]=e[2]*.5+t[2]*.5,r[3]=e[3]*.5+t[3]*.5,r):(u=Math.sin((1-n)*s)/o,a=Math.sin(n*s)/o,r[0]=e[0]*u+t[0]*a,r[1]=e[1]*u+t[1]*a,r[2]=e[2]*u+t[2]*a,r[3]=e[3]*u+t[3]*a,r))},v.fromRotationMatrix=function(e,t){t||(t=v.create());var n=e[0]+e[4]+e[8],r;if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[7]-e[5])*r,t[1]=(e[2]-e[6])*r,t[2]=(e[3]-e[1])*r;else{var i=v.fromRotationMatrix.s_iNext=v.fromRotationMatrix.s_iNext||[1,2,0],s=0;e[4]>e[0]&&(s=1),e[8]>e[s*3+s]&&(s=2);var o=i[s],u=i[o];r=Math.sqrt(e[s*3+s]-e[o*3+o]-e[u*3+u]+1),t[s]=.5*r,r=.5/r,t[3]=(e[u*3+o]-e[o*3+u])*r,t[o]=(e[o*3+s]+e[s*3+o])*r,t[u]=(e[u*3+s]+e[s*3+u])*r}return t},p.toQuat4=v.fromRotationMatrix,function(){var e=p.create();v.fromAxes=function(t,n,r,i){return e[0]=n[0],e[3]=n[1],e[6]=n[2],e[1]=r[0],e[4]=r[1],e[7]=r[2],e[2]=t[0],e[5]=t[1],e[8]=t[2],v.fromRotationMatrix(e,i)}}(),v.identity=function(e){return e||(e=v.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},v.fromAngleAxis=function(e,t,n){n||(n=v.create());var r=e*.5,i=Math.sin(r);return n[3]=Math.cos(r),n[0]=i*t[0],n[1]=i*t[1],n[2]=i*t[2],n},v.toAngleAxis=function(e,t){t||(t=e);var r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){t[3]=2*Math.acos(e[3]);var i=n.invsqrt(r);t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}else t[3]=0,t[0]=1,t[1]=0,t[2]=0;return t},v.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"};var g={};g.create=function(e){var t=new r(2);return e?(t[0]=e[0],t[1]=e[1]):(t[0]=0,t[1]=0),t},g.createFrom=function(e,t){var n=new r(2);return n[0]=e,n[1]=t,n},g.add=function(e,t,n){return n||(n=t),n[0]=e[0]+t[0],n[1]=e[1]+t[1],n},g.subtract=function(e,t,n){return n||(n=t),n[0]=e[0]-t[0],n[1]=e[1]-t[1],n},g.multiply=function(e,t,n){return n||(n=t),n[0]=e[0]*t[0],n[1]=e[1]*t[1],n},g.divide=function(e,t,n){return n||(n=t),n[0]=e[0]/t[0],n[1]=e[1]/t[1],n},g.scale=function(e,t,n){return n||(n=e),n[0]=e[0]*t,n[1]=e[1]*t,n},g.dist=function(e,t){var n=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(n*n+r*r)},g.set=function(e,t){return t[0]=e[0],t[1]=e[1],t},g.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t},g.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t},g.normalize=function(e,t){t||(t=e);var n=e[0]*e[0]+e[1]*e[1];return n>0?(n=Math.sqrt(n),t[0]=e[0]/n,t[1]=e[1]/n):t[0]=t[1]=0,t},g.cross=function(e,t,n){var r=e[0]*t[1]-e[1]*t[0];return n?(n[0]=n[1]=0,n[2]=r,n):r},g.length=function(e){var t=e[0],n=e[1];return Math.sqrt(t*t+n*n)},g.squaredLength=function(e){var t=e[0],n=e[1];return t*t+n*n},g.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},g.direction=function(e,t,n){n||(n=e);var r=e[0]-t[0],i=e[1]-t[1],s=r*r+i*i;return s?(s=1/Math.sqrt(s),n[0]=r*s,n[1]=i*s,n):(n[0]=0,n[1]=0,n[2]=0,n)},g.lerp=function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r},g.str=function(e){return"["+e[0]+", "+e[1]+"]"};var y={};y.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):t[0]=t[1]=t[2]=t[3]=0,t},y.createFrom=function(e,t,n,i){var s=new r(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s},y.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},y.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t},y.identity=function(e){return e||(e=y.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},y.transpose=function(e,t){if(!t||e===t){var n=e[1];return e[1]=e[2],e[2]=n,e}return t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3],t},y.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},y.inverse=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=n*s-i*r;return o?(o=1/o,t[0]=s*o,t[1]=-r*o,t[2]=-i*o,t[3]=n*o,t):null},y.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3];return n[0]=r*t[0]+i*t[2],n[1]=r*t[1]+i*t[3],n[2]=s*t[0]+o*t[2],n[3]=s*t[1]+o*t[3],n},y.rotate=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=Math.sin(t),a=Math.cos(t);return n[0]=r*a+i*u,n[1]=r*-u+i*a,n[2]=s*a+o*u,n[3]=s*-u+o*a,n},y.multiplyVec2=function(e,t,n){n||(n=t);var r=t[0],i=t[1];return n[0]=r*e[0]+i*e[1],n[1]=r*e[2]+i*e[3],n},y.scale=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=t[0],a=t[1];return n[0]=r*u,n[1]=i*a,n[2]=s*u,n[3]=o*a,n},y.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"};var b={};return b.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t},b.createFrom=function(e,t,n,i){var s=new r(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s},b.add=function(e,t,n){return n||(n=t),n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n},b.subtract=function(e,t,n){return n||(n=t),n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n},b.multiply=function(e,t,n){return n||(n=t),n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n[3]=e[3]*t[3],n},b.divide=function(e,t,n){return n||(n=t),n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n[3]=e[3]/t[3],n},b.scale=function(e,t,n){return n||(n=e),n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n},b.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},b.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t},b.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},b.length=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)},b.squaredLength=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i},b.lerp=function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r[2]=e[2]+n*(t[2]-e[2]),r[3]=e[3]+n*(t[3]-e[3]),r},b.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"},e&&(e.glMatrixArrayType=r,e.MatrixArray=r,e.setMatrixArrayType=i,e.determineMatrixArrayType=s,e.glMath=n,e.vec2=g,e.vec3=o,e.vec4=b,e.mat2=y,e.mat3=p,e.mat4=d,e.quat4=v),{glMatrixArrayType:r,MatrixArray:r,setMatrixArrayType:i,determineMatrixArrayType:s,glMath:n,vec2:g,vec3:o,vec4:b,mat2:y,mat3:p,mat4:d,quat4:v}}),r("layer/Renderable",["lib/gl-matrix","layer/Geometry","layer/RenderMediator"],function(e,t,n){var r=Math.round,i=e.mat3,s=e.vec2,o=[0,0],u=i.identity(),a=i.identity(),f="",l=function(e,t,n,r){e!==undefined&&t!==undefined&&n!==undefined&&r!==undefined&&this.init(e,t,n,r)};return l.prototype.init=function(e,t,n,r){this.x=e||0,this.y=t||0,this.unscaledWidth=n||0,this.unscaledHeight=r||0,this.width=this.unscaledWidth,this.height=this.unscaledHeight,this.scaleX=1,this.scaleY=1,this.rotation=0,this.transform=i.identity(),this.centerOffsetX=.5,this.centerOffsetY=.5,this.unscaledOffsetX=this.unscaledWidth*this.centerOffsetX,this.unscaledOffsetY=this.unscaledHeight*this.centerOffsetY,this.parentTransform=null,this.sceneNamespace=f,this.needsUpdate=!0,this.isInteractive=!0,this.isLeafNode=!0},l.prototype.setParentTransform=function(e){return this.parentTransform=e,this.needsUpdate=!0,this},l.prototype.setSceneNamespace=function(e){return this.sceneNamespace=e,this.setNeedsRender(),this},l.prototype.setCenterPoint=function(e,t){return this.centerOffsetX=e,this.centerOffsetY=t,this.unscaledOffsetX=this.unscaledWidth*this.centerOffsetX,this.unscaledOffsetY=this.unscaledHeight*this.centerOffsetY,this.setNeedsUpdate(),this},l.prototype.setNeedsRender=function(){return this.sceneNamespace!==f&&n.setNeedsRender(this.sceneNamespace),this},l.prototype.setNeedsUpdate=function(){return this.needsUpdate=!0,this.setNeedsRender(),this},l.prototype.updateTransform=function(){this.parentTransform?(i.set(this.parentTransform,this.transform),u=this.transform):u=i.identity(this.transform);if(this.x!==0||this.y!==0)o[0]=this.x,o[1]=this.y,i.translate(u,o);if(this.scaleX!==1||this.scaleY!==1)o[0]=this.unscaledOffsetX,o[1]=this.unscaledOffsetY,i.translate(u,o),o[0]=this.scaleX,o[1]=this.scaleY,this.width=this.unscaledWidth*this.scaleX,this.height=this.unscaledHeight*this.scaleY,i.scale(u,o),o[0]=-this.unscaledOffsetX,o[1]=-this.unscaledOffsetY,i.translate(u,o);this.rotation&&(o[0]=this.unscaledOffsetX,o[1]=this.unscaledOffsetY,i.translate(u,o),i.rotate(u,this.rotation),o[0]=-o[0],o[1]=-o[1],i.translate(u,o)),this.needsUpdate=!1},l.prototype.toLocalCoordinates=function(e,t){return this.needsUpdate&&this.updateTransform(),i.identity(a),i.multiplyVec2(i.inverse(this.transform,a),e),t&&(e[0]=r(e[0]),e[1]=r(e[1])),e},l.prototype.toWorldCoordinates=function(e,t){return this.needsUpdate&&this.updateTransform(),i.multiplyVec2(this.transform,e),t&&(e[0]=r(e[0]),e[1]=r(e[1])),e},l.prototype.hitTest=function(e,n){return o[0]=e,o[1]=n,o=this.toLocalCoordinates(o,!0),t.isPointInRect(o[0],o[1],0,0,this.unscaledWidth,this.unscaledHeight)},l.prototype.getChildHitTarget=function(e,t){return null},l.prototype.getNextChildHitTarget=function(e,t,n){return null},l.prototype.getHitTarget=function(e,t){return this},l.prototype.applyTransform=function(e){u=this.transform,e.setTransform(u[0],u[1],u[3],u[4],u[6],u[7])},l.prototype.render=function(e){this.needsUpdate&&this.updateTransform(),this.applyTransform(e)},l}),r("layer/RenderableGroup",["layer/Renderable","layer/Geometry"],function(e,t){var n=window.Math,r=n.max,i=n.min,s=[0,0],o=function(e,t,n,r){e!==undefined&&t!==undefined&&n!==undefined&&r!==undefined&&this.init(e,t,n,r)};return o.prototype=new e,o.prototype.constructor=o,o.prototype.Renderable_init=e.prototype.init,o.prototype.Renderable_updateTransform=e.prototype.updateTransform,o.prototype.Renderable_setSceneNamespace=e.prototype.setSceneNamespace,o.prototype.init=function(e,t,n,r){this.Renderable_init(e,t,n,r),this.contentX=0,this.contentY=0,this.contentWidth=0,this.contentHeight=0,this.children=[],this.isLeafNode=!1},o.prototype.setSceneNamespace=function(e){this.Renderable_setSceneNamespace(e);var t=0,n=this.children,r=n.length;for(;t<r;t++)n[t].setSceneNamespace(e);return this},o.prototype.addChild=function(e){if(this.children.indexOf(e)!==-1)throw new Error("ExistentialError: Child already exists in group");return this.children.push(e),this.needsUpdate&&this.updateTransform(),e.setSceneNamespace(this.sceneNamespace),e.setParentTransform(this.transform),this},o.prototype.insertChildAtIndex=function(e,t){if(this.children.indexOf(t)!==-1)throw new Error("ExistentialError: Child already exists in group");return e<0?this.children.unshift(t):e>=this.children.length?this.children.push(t):this.children.splice(e,0,t),this.needsUpdate&&this.updateTransform(),t.setSceneNamespace(this.sceneNamespace),t.setParentTransform(this.transform),this},o.prototype.hasChild=function(e){return this.children.indexOf(e)!==-1},o.prototype.removeChild=function(e){var t=this.children.indexOf(e);if(t===-1)throw new Error("ExistentialError: Child does not exist in group");return this.children.splice(t,1),e.setSceneNamespace(""),e.setParentTransform(null),this},o.prototype.hitTest=function(e,n){return s[0]=e,s[1]=n,s=this.toLocalCoordinates(s,!0),t.isPointInRect(s[0],s[1],this.contentX,this.contentY,this.contentWidth,this.contentHeight)},o.prototype.getChildHitTarget=function(e,t){var n=null,r=this.children,i=r.length,s=i-1;for(;s>=0;s--)if(r[s].isInteractive&&r[s].hitTest(e,t)){n=r[s];break}return n},o.prototype.getNextChildHitTarget=function(e,t,n){var r=null,i=this.children,s=i.length,o=i.indexOf(n)-1;for(;o>=0;o--)if(i[o].isInteractive&&i[o].hitTest(e,t)){r=i[o];break}return r},o.prototype.getHitTarget=function(e,t){var n=this,r=this.children,i=r.length,s=i-1;for(;s>=0;s--)if(r[s].isInteractive&&r[s].hitTest(e,t)){n=r[s].getHitTarget();break}return n},o.prototype.updateTransform=function(){this.Renderable_updateTransform();var e=0,t=this.children,n=t.length,s=this.transform,o=0,u=this.unscaledHeight,a=this.unscaledWidth,f=0,l;for(;e<n;e++)t[e].setParentTransform(s);e=0;for(;e<n;e++)l=t[e],a=i(l.x,a),u=i(l.y,u),f=r(l.unscaledWidth+l.x,f),o=r(l.unscaledHeight+l.y,o);this.contentX=a,this.contentY=u,this.contentWidth=f-a,this.contentHeight=o-u},o.prototype.render=function(e){this.needsUpdate&&this.updateTransform(),this.needsRender=!1;var t=0,n=this.children,r=n.length;for(;t<r;t++)n[t].render(e)},o}),r("layer/Layer",["layer/RenderableGroup"],function(e){var t="layer-",n=0,r=function(e,t){e!==undefined&&t!==undefined&&this.init(e,t)};return r.prototype.init=function(r,i){return r.id===undefined&&(r.id=t+n),this.name=r.id,this.canvas=r,this.context=null,this.width=r.width,this.height=r.height,this.sceneNamespace=i,this.root=new e(0,0,this.width,this.height),this.root.setSceneNamespace(this.sceneNamespace),this},r.prototype.getCanvas=function(){return this.canvas},r.prototype.getContext=function(){return this.context===null&&(this.context=this.canvas.getContext("2d")),this.context},r.prototype.getRoot=function(){return this.root},r.prototype.render=function(){var e=this.root,t=this.getContext();t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.width,this.height),e.render(t)},r}),r("layer/RenderCache",[],function(){var e=0,t="cache-",n="function",r=function(e,t,n){var r=document.createElement("canvas");return r.width=t,r.height=n,r.id=e,r},i=function(t,n,r){this.id=e++,this.width=0,this.height=0,this.canvas=null,this.context=null,this.renderCommand=null,t!==undefined&&n!==undefined&&r!==undefined&&this.init(t,n,r)};return i.createCanvas=function(e,t,n){return r(e,t,n)},i.prototype.init=function(e,i,s){if(e===0||i===0)throw"RenderCache::init - Error: width and height must be greater than 0";this.width=e,this.height=i,this.canvas=r(t+this.id,e,i),this.context=this.canvas.getContext("2d");if(typeof s!==n)throw"RenderCache::init - Error: RenderCommand is of type "+typeof s+" not of type "+n;return this.renderCommand=s,this.render(),this},i.prototype.setSize=function(e,t){return this.width=e,this.height=t,this.canvas.width=e,this.canvas.height=t,this},i.prototype.getContent=function(){return this.canvas},i.prototype.render=function(){return this.context.clearRect(0,0,this.width,this.height),this.renderCommand(this.context),this},i}),r("layer/Stage",["layer/Layer","layer/RenderCache"],function(e,t){var n=["webkitTransform"],r={webkitTransform:"matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)"},i=function(e){var t=0,i=n.length;for(;t<i;t++)e.style[n[t]]===""&&(e.style[n[t]]=r[n[t]])},s=function(e){e.id=LAYER_PREFIX+_canvasId++},o=function(e,t,n,r){e!==undefined&&t!==undefined&&n!==undefined&&r!==undefined&&this.init(e,t,n,r)};return o.prototype.init=function(t,n,r,i){if(arguments.length!==4)throw new Error("ArgumentsError: Stage expects arguments: new Stage(viewport, width, height, sceneNamespace) received "+arguments.length);this.viewport=t,this.width=n,this.height=r,this.sceneNamespace=i;var s=this.layers=[];this.layerCache={};var o=this.viewport.children,u=0,a=o.length;for(;u<a;u++)o[u].width=n,o[u].height=r,s.push(new e(o[u],i));return this.layerCount=s.length,this},o.prototype.createLayer=function(n){if(n===undefined)throw new Error("ArgumentsError: Layer name is undefined");return new e(t.createCanvas(n,this.width,this.height),this.sceneNamespace)},o.prototype.enableCSSAcceleration=function(){var e=0,t=this.layers.length;for(;e<t;e++)this.enableCSSAccelerationByIndex(e);return this},o.prototype.enableCSSAccelerationForLayer=function(e){var t=e.getCanvas();return i(t),this},o.prototype.enableCSSAccelerationByName=function(e){return this.enableCSSAccelerationForLayer(this.getLayerByName(e))},o.prototype.enableCSSAccelerationByIndex=function(e){return this.enableCSSAccelerationForLayer(this.getLayerByIndex(e))},o.prototype.createAndPrependLayer=function(e){return this.prependLayer(this.createLayer(e))},o.prototype.createAndAppendLayer=function(e){return this.appendLayer(this.createLayer(e))},o.prototype.createAndInsertLayerAtIndex=function(e,t){return this.insertLayerAtIndex(this.createLayer(e),t)},o.prototype.getLayerByName=function(e){if(!this.layerCache.hasOwnProperty(e))throw new Error("UndefinedError: Layer with name "+e+" does not exist");return this.layerCache[e]},o.prototype.getLayerByIndex=function(e){if(e<0||e>=this.layerCount)throw new Error("UndefinedError: Index "+e+" is out of bounds");return this.layers[e]},o.prototype.prependLayer=function(e){return this.viewport.hasChildNodes()?(this.viewport.insertBefore(e.getCanvas(),this.viewport.firstChild),this.layerCache[e.name]=e,this.layers.unshift(e),this.layerCount=this.layers.length,this):this.appendLayer(e)},o.prototype.appendLayer=function(e){return this.viewport.appendChild(e.getCanvas()),this.layerCache[e.name]=e,this.layers.push(e),this.layerCount=this.layers.length,this},o.prototype.insertLayerAtIndex=function(e,t){if(t<0)return this.prependLayer(e);if(t>=this.layerCount)return this.appendLayer(e);var n=this.layers[t],r=n.getCanvas();return r.parentNode.insertBefore(e.getCanvas(),r),this.layerCache[e.name]=e,this.layers.splice(t,0,e),this.layerCount=this.layers.length,this},o.prototype.forEachLayer=function(e){var t=0,n=this.layerCount;for(;t<n;t++)e(this.getLayerByIndex(t))},o}),r("layer/Scene",["layer/Stage","layer/Input","layer/HitEvent","layer/RenderMediator","layer/EventBus"],function(e,t,n,r,i){var s=function(e){e.render()},o=function(e,t,n){e!==undefined&&t!==undefined&&n!==undefined&&this.init(e,t,n)};return o.prototype.init=function(e,n,i){return this.stage=null,this.container=e,this.input=new t(e),this.sceneNamespace=this.input.getNamespace(),this.setupStage(e,n,i),this.activeTarget=null,this.activeMouse=null,this.shouldFindAllRenderables=!1,this.isEnabled=!1,r.setNeedsRender(this.sceneNamespace),this.setupHandlers().enable()},o.prototype.setupStage=function(t,n,r){return this.stage=new e(t,n,r,this.sceneNamespace),this},o.prototype.setupHandlers=function(){return this.onMoveHandler=this.onMove.bind(this),this.onUpHandler=this.onUp.bind(this),this.onDownHandler=this.onDown.bind(this),this.onClickHandler=this.onClick.bind(this),this.onInputDisableHandler=this.onInputDisable.bind(this),this},o.prototype.enable=function(){if(this.isEnabled)return this;this.isEnabled=!0;var e=this.sceneNamespace;return i.on(t.MOUSE_MOVE+e,this.onMoveHandler),i.on(t.MOUSE_UP+e,this.onUpHandler),i.on(t.MOUSE_DOWN+e,this.onDownHandler),i.on(t.CLICK+e,this.onClickHandler),i.on(t.DISABLE+e,this.onInputDisableHandler),this},o.prototype.disable=function(){if(!this.isEnabled)return this;this.isEnabled=!1;var e=this.sceneNamespace;return i.off(t.MOUSE_MOVE+e,this.onMoveHandler),i.off(t.MOUSE_UP+e,this.onUpHandler),i.off(t.MOUSE_DOWN+e,this.onDownHandler),i.off(t.CLICK+e,this.onClickHandler),i.off(t.DISABLE+e,this.onInputDisableHandler),this},o.prototype.addChild=function(e,t){return t===undefined?this.addChildToLayerByIndex(e,0):typeof t=="number"?this.addChildToLayerByIndex(e,t):typeof t=="string"?this.addChildToLayerByName(e,name):this},o.prototype.removeChild=function(e,t){return t===undefined?this.removeChildFromLayerByIndex(e,0):typeof t=="number"?this.removeChildFromLayerByIndex(e,t):typeof t=="string"?this.removeChildFromLayerByName(e,name):this},o.prototype.addChildToLayerByIndex=function(e,t){var n=this.stage.getLayerByIndex(t);return n.root.addChild(e),this},o.prototype.removeChildFromLayerByIndex=function(e,t){var n=this.stage.getLayerByIndex(t);return n.root.removeChild(e),this},o.prototype.addChildToLayerByName=function(e,t){var n=this.stage.getLayerByName(t);return n.root.addChild(e),this},o.prototype.removeChildFromLayerByName=function(e,t){var n=this.stage.getLayerByName(t);return n.root.removeChild(e),this},o.prototype.getHitStack=function(e,t){var n=[],r=null,i=this;return this.stage.forEachLayer(function(s){r=s.getRoot(),i.getDepthFirstHitStack(e,t,n,r,0)}),n},o.prototype.getDepthFirstHitStack=function(e,t,n,r,i){var s=r.getChildHitTarget(e,t);while(s!==null)n.splice(i,0,s),s.isLeafNode||this.getDepthFirstHitStack(e,t,n,s,i+1),this.shouldFindAllRenderables?s=r.getNextChildHitTarget(e,t,s):s=null},o.prototype.getHitTarget=function(e,t){var n=[],r=null;return this.stage.forEachLayer(function(i){r=i.getRoot().getHitTarget(e,t),r&&n.push(r)}),r=n.shift(),r||null},o.prototype.updateActiveTarget=function(e,t,n){var r=null;return e.length&&(r=e[e.length-1||0]),this.activeTarget!==r&&(this.activeTarget!==null&&this.onOut(this.activeTarget,t,n),r!==null&&this.onOver(r,t,n),this.activeTarget=r),this},o.prototype.getStage=function(){return this.stage},o.prototype.onInputDisable=function(e,t){this.activeTarget!==null&&this.onOut(this.activeTarget,t.x,t.y),this.activeTarget=null},o.prototype.onMove=function(e,t){var r=this.getHitStack(t.x,t.y);this.updateActiveTarget(r,t.x,t.y),this.activeMouse=t;if(r.length>0)var i=new n(n.MOUSE_MOVE,t.x,t.y,r,!0)},o.prototype.onUp=function(e,t){var r=this.getHitStack(t.x,t.y);if(r.length>0)var i=new n(n.MOUSE_UP,t.x,t.y,r,!0)},o.prototype.onDown=function(e,t){var r=this.getHitStack(t.x,t.y);if(r.length>0)var i=new n(n.MOUSE_DOWN,t.x,t.y,r,!0)},o.prototype.onClick=function(e,t){var r=this.getHitStack(t.x,t.y);if(r.length>0)var i=new n(n.CLICK,t.x,t.y,r,!0)},o.prototype.onOver=function(e,t,r){var i=new n(n.MOUSE_OVER,t,r,e,!1)},o.prototype.onOut=function(e,t,r){var i=new n(n.MOUSE_OUT,t,r,e,!1)},o.prototype.update=function(){if(!this.isEnabled)return;var e=this.activeMouse;if(e===null)return;var t=this.getHitStack(e.x,e.y);this.updateActiveTarget(t,e.x,e.y)},o.prototype.render=function(){r.getNeedsRender(this.sceneNamespace)&&this.stage.forEachLayer(s)},o}),r("layer/polar/PolarRenderable",["layer/Renderable","layer/Geometry"],function(e,t){var n=Math.sqrt,r=Math.round,i=Math.atan2,s=[0,0],o=[0,0],u=function(e,t,n,r){e!==undefined&&t!==undefined&&n!==undefined&&r!==undefined&&this.init(e,t,n,r)};return u.prototype=new e,u.prototype.constructor=u,u.prototype.Renderable_init=e.prototype.init,u.prototype.init=function(e,t,n,r){this.Renderable_init(e,t,n,r),this.radius=n||0,this.theta=r||0},u.prototype.hitTest=function(e,t){return o=this.convertWorldToPolar(e,t),this.theta===o[1]&&o[0]<=this.radius},u.prototype.toPolarCoords=function(e){return o[0]=n(e[0]*e[0]+e[1]*e[1]),o[1]=i(e[1],e[0]),o[1]<0&&(o[1]=o[1]+t.TWO_PI),o},u.prototype.convertWorldToPolar=function(e,t){return s[0]=e,s[1]=t,s=this.toLocalCoordinates(s,!0),o=this.toPolarCoords(s),o},u}),r("layer/polar/PolarRenderableGroup",["layer/RenderableGroup","layer/Geometry"],function(e,t){var n=Math.sqrt,r=Math.round,i=Math.atan2,s=[0,0],o=[0,0],u=function(e,t,n){e!==undefined&&t!==undefined&&n!==undefined&&this.init(e,t,n)};return u.prototype=new e,u.prototype.constructor=u,u.prototype.RenderableGroup_init=e.prototype.init,u.prototype.RenderableGroup_toLocalCoordinates=e.prototype.toLocalCoordinates,u.prototype.RenderableGroup_render=e.prototype.render,u.prototype.init=function(e,t,n){this.RenderableGroup_init(e,t,n,n),this.radius=n},u.prototype.hitTest=function(e,t){return s[0]=e,s[1]=t,s=this.toLocalCoordinates(s,!0),s[0]*s[0]+s[1]*s[1]<=this.radius*this.radius},u.prototype.toPolarCoords=function(e){return o[0]=n(e[0]*e[0]+e[1]*e[1]),o[1]=i(e[1],e[0]),o[1]<0&&(o[1]=o[1]+t.TWO_PI),o},u.prototype.convertWorldToPolar=function(e,t){return s[0]=e,s[1]=t,s=this.toLocalCoordinates(s,!0),o=this.toPolarCoords(s),o},u}),n(["layer/Geometry","layer/HitEvent","layer/RunLoop","layer/Input","layer/RenderMediator","layer/Layer","layer/Stage","layer/Scene","layer/RenderCache","layer/Renderable","layer/RenderableGroup","layer/polar/PolarRenderable","layer/polar/PolarRenderableGroup"],function(t,n,r,i,s,o,u,a,f,l,c,h,p){var d={};d.Geometry=t,d.HitEvent=n,d.RunLoop=r,d.Input=i,d.RenderMediator=s,d.Layer=o,d.Stage=u,d.Scene=a,d.RenderCache=f,d.Renderable=l,d.RenderableGroup=c,d.PolarRenderable=h,d.PolarRenderableGroup=p,e!==null&&(e.layer=d)},undefined,!0),r("Layer",function(){})});